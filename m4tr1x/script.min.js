(()=>{let token,socket,pwchange,chistory,hposition,loc=window.location,consoleElement=document.getElementById("console"),bodyElements=document.getElementsByTagName("body"),inputElements=document.getElementsByTagName("input"),buttonCloseElements=document.querySelectorAll("button.close"),passwordDialogElements=document.getElementsByClassName("password-dialog"),passwordClass=document.querySelector(".password"),passwordField=document.getElementById("password"),passwordCloseButton=document.querySelector(".password-dialog button.close"),storeHistory=e=>{let t;if(t=chistory.length,t>=10&&chistory.shift(),chistory.push(e),"undefined"!=typeof Storage&&0!==t)try{localStorage.setItem("history",JSON.stringify(chistory))}catch(e){}},loadHistory=()=>{let e;if("undefined"!=typeof Storage)try{e=localStorage.getItem("history"),chistory=null!==e?JSON.parse(e):[]}catch(e){chistory=[]}},storeToken=e=>{if("undefined"!=typeof Storage)try{localStorage.setItem("token",e)}catch(e){}},getToken=()=>{if("undefined"!=typeof Storage)try{return localStorage.getItem("token")}catch(e){}},logout=()=>{if(token=void 0,"undefined"!=typeof Storage)try{localStorage.removeItem("token")}catch(e){}leaveChannel()},switchColor=e=>{switchStyle(bodyElements,"color",e),switchStyle(inputElements,"color",e),switchStyle(buttonCloseElements,"color",e),switchStyle(passwordDialogElements,"border-color",e)},switchStyle=(e,t,o)=>{let n;for(n=0;n<e.length;n++)e[n].style[t]=o},getInputCursor=()=>{return consoleElement.lastElementChild},onInput=e=>{if(13==(e.keyCode||e.which)){let t=getInputCursor();if(t.innerText.length<=0)return void e.preventDefault();t.setAttribute("contenteditable","false"),t.removeEventListener("keydown",onUpDown),t.removeEventListener("keypress",onInput);let o=document.createElement("p");return o.setAttribute("contenteditable","true"),consoleElement.append(o),bindInput(o),sendCommand(t.innerText),storeHistory(t.innerText),hposition=0,void e.preventDefault()}},onUpDown=e=>{let t=e.keyCode||e.which;if(38==t||40==t){let o=getInputCursor();if((hposition+=39-t)<=0)return hposition=0,o.innerText="",setEndOfContent(o),void e.preventDefault();let n=chistory.length;hposition>=n&&(hposition=n);let s=chistory[n-hposition];return""!==s&&(o.innerText=s,setEndOfContent(o)),void e.preventDefault()}},bindInput=e=>{e.focus(),e.addEventListener("keydown",onUpDown),e.addEventListener("keypress",onInput)},hint=e=>{setTimeout(()=>{writeToConsole(e,!1)},1e3)},sendCommand=e=>{let t={};return t.type="console",t.token=token,t.command=e,post(t,processResponse)},sendAuthCommand=(e,t)=>{let o={};return o.type="authentication",o.token=e,void 0!==t&&(o.password=t),post(o,processResponse)},sendPwCommand=(e,t)=>{if(void 0!==t){let o={};return o.type="pwchange",o.token=e,o.password=t,post(o,processResponse)}},post=(e,t)=>{return fetch("/c",{body:JSON.stringify(e),headers:{"content-type":"application/json"},method:"POST"}).then(e=>{if(!e.ok)throw Error(e.statusText);return e.json()}).then(e=>{t(e)}).catch(e=>{console.log(e)})},processResponse=responseObject=>{void 0!==responseObject.token&&(token=responseObject.token,storeToken(token)),void 0!==responseObject.script&&eval(responseObject.script),responseObject.status>=200&&responseObject.status<300?void 0!==responseObject.response&&writeToConsole(responseObject.response,!0):void 0!==responseObject.response&&writeToConsole(responseObject.response,!1)},setFocus=e=>{let t=getInputCursor();document.activeElement!==t&&"Range"!==window.getSelection().type&&(t.focus(),setEndOfContent(t))},setPwFocus=e=>{document.activeElement!==passwordField&&passwordField.focus()},setEndOfContent=e=>{if(document.createRange){let t=document.createRange();t.selectNodeContents(e),t.collapse(!1);let o=window.getSelection();o.removeAllRanges(),o.addRange(t)}},passwordPromt=e=>{pwchange=e===!0,passwordClass.style.display="initial",passwordField.value="",setPwFocus()},hidePasswordPromt=()=>{passwordClass.style.display="none",passwordField.value="",setFocus()},submitPassword=e=>{13==(e.keyCode||e.which)&&(pwchange===!0?sendPwCommand(token,passwordField.value):sendAuthCommand(token,passwordField.value),hidePasswordPromt())},joinChannel=e=>{if(void 0!==socket){let t={};t.type="subscribe",t.channel=e,socket.send(JSON.stringify(t))}},leaveChannel=()=>{if(void 0!==socket){let e={};e.type="unsubscribe",socket.send(JSON.stringify(e))}},processMessage=e=>{writeToConsole(e.type+" from "+e.from+": "+e.message,!1)},writeToConsole=(e,t)=>{let o=document.createElement("p");t===!0?o.innerHTML=e:o.innerText=e,getInputCursor().insertAdjacentElement("beforebegin",o),scrollBottom()},scrollBottom=()=>{consoleElement.scrollTo(0,consoleElement.scrollHeight)},eventbus=(e,t)=>{let o=new WebSocket(("http:"==e.protocol?"ws:":"wss:")+"//"+e.hostname+(0==e.port.length?"":":"+e.port)+e.pathname.replace(/[^\/]*$/,"")+"io");o.onopen=(()=>{t=1e3,socket=o}),o.onmessage=(e=>{processMessage(JSON.parse(e.data))}),o.onclose=(()=>{socket=void 0,void 0===t&&(t=1e3),setTimeout(()=>{t<32e3&&(t*=2),eventbus(e,t)},t)}),o.onerror=(e=>{console.log("ws error: "+e.data)})};socket=eventbus(loc),writeToConsole("knock, knock, neo_",!1);let input=getInputCursor();hposition=0,loadHistory(),token=getToken(),void 0!=token&&sendAuthCommand(token),bindInput(input),consoleElement.addEventListener("click",setFocus),passwordClass.addEventListener("click",setPwFocus),passwordCloseButton.addEventListener("click",hidePasswordPromt),passwordField.addEventListener("keydown",submitPassword),"https:"===location.protocol&&"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/service-worker.js")})})();